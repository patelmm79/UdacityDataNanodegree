---
title: "Udacity Project"
author: "Milan Patel"
date: "Sunday, July 12, 2015"
output: html_document
---
#Overview


Source of data:  "[World Bank - Bangladesh Informal Firms Surveys 2010] (http://microdata.worldbank.org/index.php/catalog/2244/related_materials)"

The World Bank conducted a survey of informal firms in Bangladesh in 2010.  An informal firm is a business not registered with the authorities, as opposed to a formal business which is registered with the government, and therefore is subject to a larger degree of legal scrutiny and regulation.  Informal businesses often predominate the economy in developing countries, and often are informal due to the high cost of obtaining any sort of formal recognition from the government in terms of time  and money, particularly relative to the low or nonexistent benefit of being registered; business registration might end up being even more costly than remaining informal due to the requirement of having to then pay taxes.  


The survey asked informal business owners a series of questions covering topics ranging from business characteristics to market conditions.    Surveys were conducted in a select number of districts around Bangladesh.
Each record of the data indicates one business for which a survey is conducted, and includes district-level geography information (the second level administrative boundary after divisions).   Geographic boundary data for Bangladesh sourced via humanitarianresponse.info from World Food Programme.

My analysis intends to explore various characteristics of firms in Bangladesh; specifically, I analyze how annual revenue varies over industry sector, financing sources, and geography.


The  following R code loads the libraries and required data sets for analysis.  These data sets include the survey data from Bangladesh, and geographic Shapefile used to display the boundaries of district in Bangladesh.

`ro cache=F, warning=T, error=T, out.width="400px", out.height="400px", fig.width=25, fig.height=5, fig.align='center', dpi=500 or`
```{r set-options, echo=FALSE, cache=FALSE}

options (width = 500)




#options (width=350)
#setwd ("udacity/p3/project")#
library (rgdal)
library (ggplot2)
library (plyr)
library (stringr)
library (rgeos)
library (dplyr)
library (scales)
library (maptools)
##library (sqldf)
library (mapproj)
library (reshape2)

library (ez)



 ## load base survey data
surveydata <- read.csv ("C:\\Users\\patelmm79\\Documents\\Rdata\\Udacity\\P3\\Project\\informality_data_NEW.csv")





```



#Analysis

## A Geographic Overview of Bangladesh


```{r}
###,out.width = '1500px', out.height = '1000px'




# Geographic Shapefile containing district boundary of bangladesh
districtmap  <- readOGR (dsn="shp",layer="bgd_polbnda_adm2_wfp") 

## prepare map data
districtmap <- fortify (districtmap,region='ADM2_NAME')
districtmap$id <- toupper (districtmap$id)

#averages of variables by district
aggdata <- aggregate (surveydata, by=list (surveydata$dist), FUN=mean, na.rm=TRUE) 
## create new data frame consisting of averages in survey data, by district
aggdata$dist <- aggdata$Group.1 ## District names back into District column

# merge map and averages dataframes
plot.data <- merge (districtmap, aggdata, by.x = "id", by.y = "dist") 
# new data frame merging average data and map data


# create plot of average revenue on map of Bangladesh
ggplot () + geom_map (data=districtmap, aes (x=long, y=lat,map_id=id), 
   colour='black', fill=NA,map=districtmap)   +
   geom_map (data = aggdata, aes (map_id = dist, fill = q4_7), map = districtmap)+
   expand_limits (x = districtmap$long, y = districtmap$lat)

```


The figure above shows Average Revenue, denominated in local currency (Takas),
in the year 2009 for businesses in the surveyed districts,  A few things are made apparent on this plot.  First of all, the survey was conducted only in a
selection of districts, not the whole country, and only the surveyed districts are filled with some kind of color.  

Are there any clear geographic patterns to annual revenue?  Such a conclusion is
difficult to draw based on the information on this map.  The district with the
lowest average revenue per firm (shaded in darkrest blue)  appears to be right
in the center of the country.  There are a number of other districts that have
comparable average revenue.  The district with the highest average revenue is
shaded in light blue inn the southwest of the country; no other district seems to have a comparably high average revenue per firm.


Now, let's take a closer look at the data for annual revenue.

##Analysis of Annual Revenue variable 

Let's explore the Annual Revenue variable through a series of histograms.  

```{r}

## plot histogramm of revenue, binwidth 100000
ggplot (surveydata) + geom_histogram (aes (q4_7),binwidth=100000) +
  scale_x_continuous (limits=c (0,10000000)) +
  labs (x="Takas", title="Annual Revenue-Binwidth 100000")

## plot histogramm of revenue, binwidth 250000

ggplot (surveydata) + geom_histogram (aes (q4_7),binwidth=250000) +
  scale_x_continuous (limits=c (0,10000000))+
  labs (x="Takas", title="Annual Revenue 2009 - Binwidth 250000")


## plot histogramm of revenue, binwidth 500000
ggplot (surveydata) +   geom_histogram (aes (q4_7), binwidth=500000)+
  scale_x_continuous (limits=c (0,10000000) )+
  labs (x="Takas", title="Annual Revenue 2009- Binwidth 250000") 
```


Above histograms display distribution of values of annual revenue for 2009.  I chose to use thre histograms to display the same variable, with different binwidths, which  allows us to view the data from an increasingly generalized perspective.  We can see that the distribution is not normal--it is a negative exponential distribution (skewed to the left).  The distribution makes sense, if one expects that most firms in Bangladesh are small and would not have a high revenue.  

What does the differencces in binwidth tell us?  The histogram with binwidth of 100000 demonstrates that the data periodically spikes, and does not appear as smooth as the next 2 histogramms. These spikes likely result because survey respondents would tend to give estimated answers, corresponding to roundded increments.  

The second histogram reduces the number of spikes substantially, and the third almost eliminates them entirely, creating a smooth staircase shape.  I believe that the second histogram sufficiently manages the spikes without totally eliminating the variety of responses, so I believe that one is the best to use.

Applying logarithmic adjustment, we can create a new histogram:

```{r}
## plot histogram of log of revenue
ggplot (data=surveydata, aes (log10 (q4_7))) + geom_histogram ()
```                            
                                    
The logarithmic adjustment of the annual revenue variable creates a new histogram that displays the data as a normal distribution.  

Let's take another view of business size, by comparing annual revenue to number of employees.

```{r}

#plot number of employees vs annual revenue
ggplot (surveydata, aes (y=q4_7, x=q1_12a5a)) + geom_point () +           
  scale_x_continuous (limits = c (0, 20)) + 
  scale_y_continuous (limits = c (0, 10000000)) + 
  scale_fill_continuous (guide = guide_legend ())
```

The plot above displays number of employees in the firm on the x axis, and annual revenue on the y axis.  It is difficult to discern any clear pattern;  We appear to have a problem with overplotting, as many of the data points appear to overlap.  This probably results from the fact that number of emmployes is an integer, and is limited on the graph to a value of 20.  Let's add a jitter to the plot to make things clearer.
 
```{r}
ggplot (surveydata, aes (y=q4_7, x=q1_12a5a)) + geom_jitter (alpha=1/5)+
  scale_x_continuous (limits = c (0, 20)) +  
  scale_y_continuous (limits = c (0,10000000)) +
  scale_fill_continuous (guide = guide_legend ())
```

The jitter does help somewhat to make clear the varied relationship between number of employees and annual revenue.  It makes sense that there is an overall positive relationship, but based on this plot, the relationship does not appear to be that strong.  There seems to be many instances of a low number of employees with high revenue, and high number employees with a low revenue.  



Let's take another view of this relationship, by applying a logarithmic scale to the annual revenue, and maintaining the jitter.

```{r}
ggplot (surveydata, aes (y=log10 (q4_7), x=q1_12a5a)) +geom_jitter (alpha=1/5)+
  scale_fill_continuous (guide = guide_legend ())+
  scale_x_continuous (limits=c (0,20))
```

The application of this change seems to make clearer a positive relationship between annual revenue and number of employees.  


Let's numerically verify this relationship by calculating the correlation between number of employees and annual revenue.


```{r}
cor.test (surveydata$q4_7,surveydata$q1_12a5a,method='pearson')


```

The correlation value of .337 indicates that there is a relationship between the number of employees and annual revenue, albeit it cannot be chacterised as a strong relationship.

##Analysis of Business Classifications

What type of businesses were surveyed, and is it possible to explore some of their characteristics?  Perhaps a more insightful question would be, is it possible to determine if annual revenue varies by business sector?  

The survey data includes information about the industry classification of the business; the business information is given via the ISIC code, an industry classification system.  ISIC is a 4-tiered classification system, with the lower 3 tiers represented by a numeric code, and a corresponding top level represented by a letter. The lowest (and most granular) level is represented by a 4-digit code.  



The following 2 lists and pie chart are intended to explore through the different classification levels within the data.  I wish to find the right level of granularity to the classification data that can further facilitate analysis.  There is a balance to be achieved; granular classifications could yield granular insights, but may require an unwieldy number of posible classifications; too few classifications could inhibit any meaningful analysis, because we need a critical mass of observations to make good ,generalizable observations for classifications of data.

The following code imports the ISIC code descriptions, and adds the descriptions to the survey data.  The ISIC classification descriptions were sourced from the "[UN Department of Economic and Social Affairs] (http://unstats.un.org/unsd/cr/registry/regcst.asp?Cl=27)"; some manipulation of this data was required to shorten the category descriptions, for better display of names on the plots, and to create better mapping between different codes.

```{r}
##options (width=120)

#ensure that ISIC code is set as factor

surveydata$q1_2 <- as.factor (surveydata$q1_2)

#import ISIC reference data
isicdata <- read.csv ("ISIC_Rev_3_english_structure.csv")  
# take first 2 digits of ISIC code in data to create new ISIC1 column
surveydata$ISIC2_code <- substr (surveydata$q1_2,1,2)  

# add ISIC1 description to survey data
surveydata$ISIC_section <-
  isicdata$SectionCode[match (surveydata$q1_2,isicdata$Code)]


  # add ISIC1 description to survey data
surveydata$ISIC_sectiondesc <- 
  isicdata$SectionDesc[match (surveydata$q1_2, isicdata$Code)] 

# add ISIC1 description to survey data
surveydata$ISIC2_desc <- 
  isicdata$Desc_short[match (surveydata$ISIC2_code, isicdata$Code)]

# add ISIC3 description to survey data
surveydata$ISIC4_desc <- isicdata$Description[match (surveydata$q1_2, isicdata$Code)]



write.table (surveydata, "surveydata_with_ISIC.csv", sep=",")
```


###ISIC Level 2 Number of Businesses

```{r fig.height=50}
## display number of businesses by ISIC2 code
arrange (count (surveydata,ISIC2_desc),desc (n)) 

```


###ISIC Level 4 Number of Businesses

```{r}
## display number of businesses by ISIC4 code
arrange (count (surveydata,ISIC4_desc), desc (n))
```

###ISIC Number of Businesses by Section

```{r}
## display number of businesses by ISIC section (top level)
ggplot (surveydata, aes (x=factor (1),  fill=ISIC_sectiondesc))+
  geom_bar (width = 1)+ coord_polar ( "y") 

```


The most granular level of classification, Level 4, has 76 distinct values in the data set, while Level 2 has 30 distinct values.  For purposes of initial exploration (especially visually), both present a very large number of distinct values.  However, the ISIC Section level has 7 distinct values,  which seems to be an ideal number of values with which to explore.  The other variables may be useful to conduct deeper analysis at some point.  The risk of using the ISIC Section level will be that there is too much concentration in a few variables; indeed, looking at the pie chart under "ISIC Number of Businesses by Section" shows that over 50% of busineses are classified under "Retail and Repair".   


Let's begin by comparing profit levels for the different ISIC sections.


We will first facet annual revenue by ISIC section.

```{r}

ggplot (surveydata) +  
  geom_histogram (aes (q4_7), binwidth=250000)+
  scale_x_continuous (limits=c (0,10000000) )+
  labs (x="Takas", title="Annual Revenue 2009- Binwidth 250000")  + 
  facet_wrap (~ISIC_sectiondesc)


```
On the surface, the faceted histograms reveal a variety of distributions.  Sections Manufacturing, Retail & Repair, and "Other community" have a very clearly left-skewed exponential distribution.  Hotels and restaurants, on the other hand, seem to have a very flat distribution.  But let's have a closer look.


```{r}

##plot histogram of annual revenue--hotels & restaurants

ggplot (subset (surveydata, surveydata$ISIC_section=='H')) + 
  geom_histogram (aes (q4_7), 
  binwidth=500000)+scale_x_continuous (limits=c (0,10000000) )+
  labs (x="Takas", title="Annual Revenue 2009- Hotels and Restaurants")  

```

From this perspective, the distribution is similar to the ones already mentioned--with an exponential distribution.  The distribution was not as apparent in the faceted plot, because the y axis limit was more appropriate for those sections with more observations in the data, and therefore higher counts.  This points to a limitation in making comparisions using faceted views: if the number of observations for each faceted varies widely, it is difficult to make accurate observations across all facets.

Let's use box plots to examine the relationship between ISIC sections and revenue.

###Boxplot -- Revenue by ISIC Section

```{r}

ggplot (aes (x=ISIC_sectiondesc,y=q4_7),
  data=subset (surveydata,ISIC_section !=''))+
  geom_boxplot ()+coord_cartesian (ylim=c (0,10000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))

```


The box plot does reveal variation of revenue levels across Sections; Hotels & Restaurants show the highest median level of profit, and Health & Social Work shows the lowest level of median profit (note though the relatively small number of observations in the data set for this category, as evidenced by the pie chart "ISIC Number of Businesses by Section").  Manufacturing, Logistics & Communications, and Retail & Repair have comparable median levels.  Logistics & Communications has the widest difference between the 1st and 3rd quartiles.

Let's explore the actual values to confirm above analysis.

```{r}
by (surveydata$q4_7,surveydata$ISIC_sectiondesc, summary)

```

The observations taken from analysis of the boxplot are confirmed by the summary of the statistics above. Hotels and restaurants have a median of 2948000 takas--the next highest median value is for Retail & Repair, with 2184000 takas.


As another measure of business size, how does the number of employees vary across ISIC sections?

```{r}
ggplot (aes (x=ISIC_sectiondesc,y=q1_12a5a),
  data=subset (surveydata,ISIC_section !=''))+
  geom_boxplot ()+coord_cartesian (ylim=c (0,50)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))
```

Based on this boxplot, section Hotels & Restaurants has the highest median number of employees, followed by Manufacturing.  The medians for those sections are significantly higher than the other sections, and the difference betweeen 1st and 3rd quartiles wider.
###Point Plot comparison - Annual Revenue & Number of Employees by ISIC section
Now, let's explore the two size characteristics together with the  ISIC section, all on the same point plot. 


```{r}
ggplot (surveydata, aes (y=q4_7, x=q1_12a5a, colour=ISIC_sectiondesc)) +
  geom_point () + scale_x_continuous (limits = c (0, 50)) + 
  scale_y_continuous (limits = c (0, 10000000)) +
  scale_fill_continuous (guide = guide_legend ())


```

And above plot, but applying logarithmic scale to annual revenue:


```{r}
ggplot (surveydata, aes (y=log10 (q4_7), x=q1_12a5a, colour=ISIC_sectiondesc)) +
  geom_jitter (alpha=1/5) +
  scale_fill_continuous (guide = guide_legend ())+
  scale_x_continuous (limits=c (0,20)) +
  scale_fill_continuous (guide = guide_legend ())

```

What is apparent in the first plot is made more explicit in the second plot (the one with the logarithmic adjustment applied to annual revenue): how intensively different ISIC sections utilise labor.  ISIC section Retail & Repair has revenue that grows very quickly for a small growth of number of employees; however, in sectors Hotels & Restaurants and Manufacturing, annual revenue increases more slowly as number of employees grow--implying that those sectors are more dependent on labor for growth.   

###
```{r}
select_sections <- c ('D','G','H','O')

ggplot (aes (y=q4_7,x=q1_12a5a),
  data=subset (surveydata,ISIC_section %in% select_sections ))+
  geom_line (aes (color=ISIC_sectiondesc),stat='summary',fun.y=median)+
  scale_x_continuous (limits = c (0, 50)) 
```
This line plot shows the relationship between revenue and number of employees for selected sectors.  This plot shows much more explicitly what was inferred in the previous plot: that revenue increases quite sharply as the number of employees grows for the Retail & Repair Section, and much more gradually for the other sectors.

Let's explore the correlation between revenue and number of employees by section.

####Correlation -- Annual Revenue to Employees, section Manufacturing
```{r}
with (surveydata, cor.test (~q4_7 +
  q1_12a5a,subset= (ISIC_section=="D"),method='pearson'))
```

####Correlation -- Annual Revenue to Employees, section Retail
```{r}
with (surveydata, cor.test (~q4_7 + 
   q1_12a5a,subset= (ISIC_section=="G"),method='pearson'))
```

####Correlation -- Annual Revenue to Employees, section Hotels and Restaurants
```{r}
with (surveydata, cor.test (~q4_7 + 
  q1_12a5a,subset= (ISIC_section=="H"),method='pearson'))
```


####Correlation -- Annual Revenue to Employees, section Other Community
```{r}
with (surveydata, cor.test (~q4_7 +                           
  q1_12a5a,subset= (ISIC_section=="O"),method='pearson'))
```

One can see that the correlations vary quite widely by industry.  In the Manufacturing and Retail & Repair sections, the correlations of .348 and .378 are substantial, but not particularly strong.  The correlation in section Other Commmunity is the weakest of the 4 selected sections, .217.  On the other hand, in section "Hotels and Restaurants", the correlation of .828 is much higher than the other sections.  

Do these correlations contradict what we inferred in the previous plots?  Perhaps we can say that the correlations temper those findings.  So while there is something of a tendency in the Retail & Repair section for revenue to increase as the number of employees increases, the correlation indicates that the relationship exists but is not particularly strong; further we have not done any analysis to quantify the intensity of the relationshp where it exists.  

In any case, this avenue of analysis has been an interesting exploration of the labour intensity by different industries.  We can potentially dig deeper by using the more granular ISIC classifications.

## Exploring the sources of financing for businesses


Now, let's explore some of the other characteristics of the business.  The dataset  contains information about sources of loans.  The respondent is asked to give a series of yes / no answers about whether the business takes credit from various types of sources, such as banks or moneylenders.  In order to create a plot that can allow us to compare the responses, the data requires some manipulation to achieve the right input format.  I used the "melt" function in the "reshape2" function to do so.  

```{r}

# Reshape data to create new column for finance source responses
survey_q35a1 <- melt (surveydata[,c ("slno","q3_5a1")],id.vars=c ("q3_5a1"))  
survey_q35a1$financesource <- c ("Private bank")
survey_q35a1$fsabrev <- c ("P")
names (survey_q35a1)[1] <- c ("response")


survey_q35a2 <- melt (surveydata[,c ("slno","q3_5a2")],id.vars=c ("q3_5a2"))   
survey_q35a2$financesource <- c ("Government bank")
survey_q35a2$fsabrev <- c ("G")
names (survey_q35a2)[1] <- c ("response")


survey_q35a3 <- melt (surveydata[,c ("slno","q3_5a3")],id.vars=c ("q3_5a3"))   
survey_q35a3$financesource <- c ("Microfinance Organization")
survey_q35a3$fsabrev <- c ("M")
names (survey_q35a3)[1] <- c ("response")


survey_q35a4 <- melt (surveydata[,c ("slno","q3_5a4")],id.vars=c ("q3_5a4")) 
survey_q35a4$financesource <- c ("Moneylender")
survey_q35a4$fsabrev <- c ("L")
names (survey_q35a4)[1] <- c ("response")

survey_q35a5 <- melt (surveydata[,c ("slno","q3_5a5")],id.vars=c ("q3_5a5"))  
survey_q35a5$financesource <- c ("Family and Friends")
survey_q35a5$fsabrev <- c ("F")
names (survey_q35a5)[1] <- c ("response")

survey_q35a6 <- melt (surveydata[,c ("slno","q3_5a6")],id.vars=c ("q3_5a6")) 
survey_q35a6$financesource <- c ("Other")
survey_q35a6$fsabrev <- c ("O")
names (survey_q35a6)[1] <- c ("response")

# bind all response tables together
survey_financesource <- rbind (survey_q35a1,survey_q35a2)
survey_financesource <- rbind (survey_financesource,survey_q35a3)
survey_financesource <- rbind (survey_financesource,survey_q35a4)
survey_financesource <- rbind (survey_financesource,survey_q35a5)
survey_financesource <- rbind (survey_financesource,survey_q35a6)
survey_financesource$response <- as.factor (survey_financesource$response)
survey_financesource$slno <- survey_financesource$value

#merge combined response table to rest of data

survey_finc_merged <- 
  merge (x = surveydata, y =survey_financesource , by = "slno", all.x = TRUE)

# subset of 
surveyfinance_yes <- 
  subset (survey_financesource,survey_financesource$response=='1')


# boxplot of finance source responses
ggplot (aes (x=response, y=q4_7),
  data=subset (survey_finc_merged,survey_finc_merged$response !="NA"))+
  geom_boxplot ()+coord_cartesian (ylim=c (0,20000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~financesource)



```


These faceted boxplot reveal that the sources of credit (x axis, 1= Yes, 2 = No) varied widely by annual revenue (y axis).  Government and Private Banks showed by far a higher median revenue than the other options, and the difference between 1st and 3rd quartiles is mmuch wider than the other sources, indicating that the Banks lent a wider variety of larger amounts.  Firms with smaller revenue turned to Family and Friends, Moneylenders, and Microfinance organisations for credit; that they would do so is not surprising, considering that banks have traditionally lent to larger and more established firms.  Microfinance organisations, moneylenders, and family & friends are often sources of credit for busineses who have trouble obtaining loans from banks.


```{r} 
by (surveyfinance_yes$value,surveyfinance_yes$financesource,summary)
```
A look at the actual summary statistics for the loan data confirms above assessment: median loan size for Government Banks (6350000) and Private Banks (4800000) are far higher than the other sources of credit; the closest is Moneylenders at 23000000 takas.  


##Does the lending vary by sector?

Let's look at how the different categories of lenders lend in different sectors.


###Lending by sector -- Government Banks


```{r}

ggplot (aes (x=response, y=q4_7),
  data=subset (survey_finc_merged,survey_finc_merged$financesource=='Government bank'))+
  geom_boxplot ()+
  coord_cartesian (ylim=c (0,30000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~ISIC_sectiondesc)

```
For firms borrowing from government banks, What is immediately clear is the median annual revenue and 1st & 3rd quartiles for firms in the manufacturing sector is markedly higher than the other sectors  (in this example, literally off the charts, because I chose the scaling to be consistent with the other lending categories and not distort the results in the other sectors).  Hotels and restaurants that borrow from government banks have the nest highest median value for annual revenue, with Retail & Repair after that.  None of the other sectors seem to receive loans from Government Banks in any significant way.
###Lending by sector -- Moneylender
```{r}

ggplot (aes (x=response, y=q4_7),data=subset (survey_finc_merged,survey_finc_merged$financesource=='Moneylender'))+geom_boxplot ()+coord_cartesian (ylim=c (0,30000000)) + scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+facet_wrap (~ISIC_sectiondesc)
```

For firms that borrow from  Moneylenders, again the revenue for Manufacturing seems to be much higher than in the other sectors--though for manufacturing,the median value and box quartiles are much lower than manufacturing firms that borrow from Government Banks. In comparison, the revenue in other sectors that borrow from moneylenders seems to be negligiible; however, the scaling in place to facilitate comparison between lender types may also distort our perspective.  Let's have a look at the same chart, but with an adjusted scale on the Y axis.

###Lending by sector -- Moneylender -- Y axis rescaled

```{r}

ggplot (aes (x=response, y=q4_7),
       data=subset (survey_finc_merged,
  survey_finc_merged$financesource=='Moneylender'))+
  geom_boxplot ()+coord_cartesian (ylim=c (0,15000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~ISIC_sectiondesc)
```


It seems that the scale adjustment only seems to emphasise the high annual revenue of manufaccturers.  The sector with the next highest median revenue is Retail & Repair, but that is substantially lower than that of Manufactiring.

###Lending by sector -- Microfinance


```{r}


ggplot (aes (x=response, y=q4_7),
  data=subset (survey_finc_merged,
  survey_finc_merged$financesource=='Microfinance Organization'))+
  geom_boxplot ()+coord_cartesian (ylim=c (0,30000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~ISIC_sectiondesc)
```

Microfinance lenders, in contrast to the above two lender types, appears to have a much lower level of lending to firms in the Manufacturing section.  In fact, the ISIC section which appears to have higher levels of lending than all of the other sections is Logistics & Communications.  

Let's look at the rescaled on the y axis to better understand lending by Microfinance.

```{r}

ggplot (aes (x=response, y=q4_7),
  data=subset (survey_finc_merged,
  survey_finc_merged$financesource=='Microfinance Organization'))+
  geom_boxplot ()+
  coord_cartesian (ylim=c (0,15000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~ISIC_sectiondesc)
```

The rescaled view confirms what we saw before: that Microfinance loans are made to firms in the Logistics & Communications section, that have median revenue much higher than in other sections.  After that section, the section with the next highest median revenue is Hotels and Restaurants; Manufacturing and Retail  & Repair follow, and appear to have about the same median revenue.  It's worth noting that other than Logistics & communications , in the other 3 sections that receive siginficant microfinance lending, the level of revenue for those firms that receive microfinance loans tend to be lower than those firms that do not; for example, in the Retail & Repair section, median revenue for those firms that receive microfinance loans is lower than firms that do not.  Such a situation is no surprise: Microfinance lenders offer smaller loans designed for smaller firms.  Bearing that in mind, however, the revenues in the Logistics & communications section for firms that borrow from Microfinance lenders seems anomalously high. 

Due to the hierarchial nature of the ISIC classification system, we can take a look at the most granular ISIC level, to try to obtain more granular insights.


###Annual revenue for Transport firms that borrow from Microfinance lenders

```{r}

survey_transport <- 
  subset (survey_finc_merged,survey_finc_merged$fsabrev=="M" & 
  survey_finc_merged$ISIC_section=='I' & !is.na (response)& !is.na (ISIC2_desc))


survey_transport$response <- as.factor (survey_transport$response)


write.table (survey_transport, "transport.txt", sep="\t")
  
 
ggplot (aes (x=response, y=q4_7),
  data=survey_transport)+
  geom_boxplot ()+coord_cartesian (ylim=c (0,20000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~ISIC4_desc,ncol=3)

```

In fact, the boxplots indicate that within the Logistics & Communcations section, the only firms that receive Microfinance loans have ISIC level 4 of "Telecommunications".  




# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}
options (scipen=10000)  ### remove scientific notation scaling on legend

## locations and populations of major cities (over 1 million people)
MajorCitiesBangladesh <-  data.frame (City=c ("Dhaka","Chittagong","Khulna"),
                                   Population=c (10356500,3390222,1342339),
                                   Longitude=c (90.407,91.832,89.564),
                                   Latitude=c (23.71,22.338,22.81))  
      
###Create plot 1 

ggplot () + 
  ###first map layer: base map
geom_map (data=districtmap, aes (x=long, y=lat,map_id=id), 
    colour='black', fill=NA,map=districtmap) + 
  ggtitle ("Figure 1: Average Monthly Profit by District")  +  
 #second mmap layer: fill based on a
 geom_map (data = aggdata, aes (map_id = dist, fill = q4_7), map = districtmap) + 
  expand_limits (x = districtmap$long, y = districtmap$lat) +
  scale_fill_continuous (name="Takas", label=comma) +
  geom_point (data=MajorCitiesBangladesh, aes (x=Longitude, y=Latitude, 
  size=Population), color="orange")+   scale_y_continuous (label=comma)+
  geom_text (data = MajorCitiesBangladesh, aes (x = Longitude, y = Latitude, 
  label = City), size =5, color="red")  
```


### Description One

My first final plot is the map of Bangladesh that we used near the beginning of this project, adding some features to provide some context.  First of all, I plotted on the map the 3 largest cities in Bangladesh, with orange circles indicating population size of each.  As wealth often concentrates in urban areas (typicallly being centers of economic activity), I wanted to test the idea that firms with the largest level of revenue coincided with major urban centers in Bangladesh.  In fact, in this case, we note that the highest average revenue coincides with the three major urban centers; Khulna district has the highest average revenue of 29 million takas, and also contains the city of Khulna, the 3rd largest in Bangladesh.  Chittagong district, with the second highest average revenue (15.5 million takas), also contains the second-largest city in Bangladesh.  And the district with the 3rd highest average revenue (15.1 million takas)  is Dhaka district, where the capital and largest city of Bangladesh is located.

So, it seems that urbanization in Bangladesh coincides with high annual revenue for firms in those urban locations.



### Plot Two
```{r echo=FALSE, Plot_Two}
###Create plot 2

ggplot (surveydata, aes (y=log10 (q4_7), x=q1_12a5a, colour=ISIC_sectiondesc))+
  geom_jitter (alpha=.4) +scale_x_continuous (limits=c (0,20)) +
  geom_smooth (data=subset (surveydata,
  surveydata$ISIC_sectiondesc=="Manufacturing"),
  aes (y=log10 (q4_7),x=q1_12a5a),method=lm,se=FALSE)+
  scale_fill_discrete (name="ISIC Section")+
  geom_smooth (data=subset (surveydata,
  surveydata$ISIC_sectiondesc=="Retail & Repair"),
  aes (y=log10 (q4_7),x=q1_12a5a),method=lm,se=FALSE)+
  geom_smooth (data=subset (surveydata,
  surveydata$ISIC_sectiondesc=="Hotels and restaurants"),
  aes (y=log10 (q4_7),x=q1_12a5a),method=lm,se=FALSE)+
  labs (x="Number of Employees", y = "log (Annual Revenue 2009, Takas)")+
  scale_color_discrete (name="ISIC Section") + 
  ggtitle ("Size Characteristics of Firms in Bangladesh,
          \n grouped by ISIC Section")  
```


### Description Two


Plot two builds on the point plot comparison above, and refines to add trendlines to the plot.  This plot has the following features:

* A log10 scale is applied to the Y axis (Annual Revenue 2009);
* Jitter is applied to avoid overclustering of points;
* The points are colored by ISIC section;
* Trendlines are added for select ISIC sections, to highlight the differences between them.
 
The trendlines emphasize the findings from the original plot: within the Retail & Repair section, annual revenue increases at a distinctly faster rate as employees increase, than in the Manufacturing andd Hotels and restaurants section.   Using the combination of plotting methods, we have been able to identify a differentiating characteristic between certain sectors: at higher levels of revenue, Retail & Repair firms feature fewer employees than the Manufacturing and Hotels & Restaurants sections.

### Plot Three
```{r    echo=FALSE, Plot_Three}
##fig.width=30, fig.height=20,
options (width = 500)



##Subset the data for seleccted finance sources

surveyfinance_select1 <- subset (survey_finc_merged, 
  subset= financesource %in% c ("Microfinance Organization",
  "Government bank","Moneylender"))


####Subset for selected ISIC sections
surveyfinance_select <- subset (surveyfinance_select1, 
  subset = ISIC_sectiondesc %in% c ("Manufacturing","Retail & Repair",
   "Hotels and restaurants", "Logistics & Communications" )) 

##set order off finance sources in box plot

surveyfinance_select$financesource =factor (surveyfinance_select$financesource,
   c ("Microfinance Organization","Moneylender","Government bank"))

## set order of ISIC sections in box plots
surveyfinance_select$ISIC_sectiondesc=
  factor (surveyfinance_select$ISIC_sectiondesc, 
  c ("Manufacturing","Hotels and restaurants", "Retail & Repair", 
    "Logistics & Communications" ) )  



###Create plot 3

ggplot (aes (x=financesource, y=q4_7, fill=financesource),
  data=subset (surveyfinance_select,  surveyfinance_select$response==1))+ 
  geom_boxplot ()+
  coord_cartesian (xlim=c (0,20000000)) + 
  scale_x_discrete (labels = function (x) str_wrap (x, width = 15))+
  facet_wrap (~ISIC_sectiondesc, ncol=1) +  coord_flip (ylim=c (0,45000000)) +
  labs (x="Source of Financing", y = "Annual Revenue 2009, Takas")+
  scale_fill_discrete (name="Source of Financing") +
  ggtitle ("Annual Revenue 2009 for firms in Bangladesh,
          \n by ISIC Section and Sources of Financing")



```

### Description Three

Plot three is a refinement of the box plots that were explored above.  Those box plots informed the creation of plot three in an number of ways.  

Firrst, to make an effective and attractive visualization that captures the salient observations of our findings, it would be an idea to limit the number of items within the categories on the plot.  For the ISIC section variable, I selected items that have enough observations to be able to draw meaningful insights; we can tell from the box plots and the point plots that items within the ISIC section category, such as "Health & Social Work"" and "Other Community" do not have many observations--so it is difficult to glean any insights about those sections.  I selected 3 sections: "Hotels and restaurants", "Manufacturing", and "Retail and Repair"--the items that I also highlighted in plot two with trend lines.  Also, considering the other categorical variable, Source of Financing, I had noted that the 3 items from ISIC Section had displayed some distinctive characteristics as the source of financing change; additionally,  I also included "Logistics and Communications", as for the Source of Financing "Microfinance Organization", the revenue patterns were distinctive when compared to the other ISIC sections.

Second, I noted that when  faceting the Source of Financing "Government Banks", it was difficult to create a scale that could adequately show the range of responses for annual revenue; scaling on the y axis that appropriately showed the "Manufacturing" seciton would distort the plots of the other sections.  To resolve this issue, I applied the "coord_flip" option to make a horizontal boxplot.  

Third, I saw that being specific about the order of the data would help to bring out the story of the data.  So, I adjusted the input data frame to order both categorical variables, to generally place the ISIC sections and sources of financing with higher annual revenue towards the top of the plot, while maintaining the order of sources of financing within each sub-plot to facilitate comparison.  

This plot captures the relevant information that we gathered from the box plots.  We can observe that government banks tend to provide credit to firms with higher levels of revenue, while moneylenders and microfinance organizations tend to lend to firms with relatively lower levels of revenue.  We can also see the differentiated levels of revenue between the different ISIC sections, with Manufacturing firms having a markedly higher revenue than the other sectors.  

Most interestingly, we can observe a potential segmentation of the finance market, by discerning patters of how different lenders tend to lend to different industries.  Microfinance organizations are designed to lend to firms of a very small size--and so one would expect that the firms who receive credit from such sources would have a lower annual revenue. This seems to hold true in most of the sections; however, we can see that firms in Logistics & communications that receive microfinance loans have a median revenue that is much higher than microfinance loan recipients in other sections.  Government banks, on the other hand, may tend to target credit towards larger firms--hence the phenomenon of 
firms in the Manufacturing sector that take government bank loans, that show much higher levels of revenue than in other sections; hence, manufactuers seem to be a good market segment for government banks.  Indeed, the growth of manufacturing in Bangladesh has been a well-known story of success, so much so that it is probably considered to be a strategic industry in the country--something that governments would tend to encourage (see http://www.mckinsey.de/sites/mck_files/files/2011_McKinsey_Bangladesh.pdf for more information).






------

# Reflection

This process has been moderately successful in elucidating some insights about trends in Bangladeshi firms' annual revenue across a number of dimensions, such as geography, industry sector, and financing source.  One major limitation of this analysis was that such insights were limited to only a selection of ISIC sections; this limitation was probably due to the limited availabilty of observations for ISIC sections beyond those that we examined in depth.  

One initial challenge that I had to work through was how to choose a limited set of variables to explore, when so many were available.  This also means that there is a lot more data to explore within this data set; the data includes information such as family characteristics and education levels of business owners.  Within this data set, believe there are many other opportunities to segment businesses based on differing characteristics other than the ones we explored here.



